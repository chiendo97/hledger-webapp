<!-- Modal overlay -->
<div id="tx-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/70" onclick="if(event.target===this)document.getElementById('modal').innerHTML=''">
  <div class="bg-gray-900 border border-gray-700 rounded-xl w-full max-w-lg lg:max-w-2xl mx-4 max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">

    {# ── View mode ── #}
    <div id="tx-view">
      <div class="flex justify-between items-center p-4 border-b border-gray-800">
        <h2 class="text-lg font-semibold">Transaction #{{ tx.tindex }}</h2>
        <button onclick="document.getElementById('modal').innerHTML=''" class="text-gray-400 hover:text-white text-xl">&times;</button>
      </div>
      <div class="p-4 space-y-3">
        <table class="w-full text-sm">
          <tbody>
            <tr class="border-b border-gray-800">
              <td class="text-gray-400 py-1.5 pr-4 whitespace-nowrap align-top">Date</td>
              <td class="text-gray-100 py-1.5 text-right">{{ tx.tdate }}</td>
            </tr>
            <tr class="border-b border-gray-800">
              <td class="text-gray-400 py-1.5 pr-4 whitespace-nowrap align-top">Description</td>
              <td class="text-gray-100 py-1.5 text-right break-all">{{ tx.tdescription }}</td>
            </tr>
            {% for tag in tx.tags %}
            <tr class="border-b border-gray-800">
              <td class="text-gray-500 py-1.5 pr-4 font-mono whitespace-nowrap align-top">{{ tag.key }}</td>
              <td class="text-gray-300 py-1.5 text-right">{{ tag.value }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        <table class="w-full text-sm">
          <tbody>
            {% for p in tx.tpostings %}
            <tr class="border-b border-gray-800">
              <td class="text-gray-300 py-1.5 pr-2 break-words">{{ p.paccount }}</td>
              {% if p.balance_assertion_display %}
              <td class="font-mono py-1.5 text-right whitespace-nowrap text-gray-500">= {{ p.balance_assertion_display }}</td>
              {% else %}
              <td class="font-mono py-1.5 text-right whitespace-nowrap {% if p.pamount[0].aquantity.floatingPoint < 0 %}text-red-400{% else %}text-green-400{% endif %}">{{ p.amount_display }}</td>
              {% endif %}
            </tr>
            {% if p.tags %}
            {% for tag in p.tags %}
            <tr>
              <td colspan="2" class="pl-4 py-0.5 text-xs text-gray-500"><span class="font-mono">{{ tag.key }}</span> {{ tag.value }}</td>
            </tr>
            {% endfor %}
            {% endif %}
            {% endfor %}
          </tbody>
        </table>
        <div class="flex gap-2 pt-3 border-t border-gray-800">
          <button onclick="document.getElementById('tx-view').classList.add('hidden');document.getElementById('tx-edit').classList.remove('hidden')"
                  class="flex-1 bg-blue-600 hover:bg-blue-500 text-white text-sm py-2 rounded-lg">Edit</button>
          <button onclick="document.getElementById('modal').innerHTML=''"
                  class="flex-1 bg-gray-700 hover:bg-gray-600 text-white text-sm py-2 rounded-lg">Close</button>
        </div>
      </div>
    </div>

    {# ── Edit mode ── #}
    <div id="tx-edit" class="hidden">
      <div class="flex justify-between items-center p-4 border-b border-gray-800">
        <h2 class="text-lg font-semibold">Edit Transaction</h2>
        <button onclick="document.getElementById('modal').innerHTML=''" class="text-gray-400 hover:text-white text-xl">&times;</button>
      </div>
      <form hx-post="/transactions/{{ tx.tindex }}" hx-target="#modal" hx-swap="innerHTML" class="p-4 space-y-3">
        <div>
          <label class="text-xs text-gray-400">Date</label>
          <input type="date" name="date" value="{{ tx.tdate }}"
                 class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-sm mt-1">
        </div>
        <div>
          <label class="text-xs text-gray-400">Description</label>
          <input type="text" name="description" value="{{ tx.tdescription }}"
                 class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-sm mt-1">
        </div>

        {# ── Tags (key:value) ── #}
        <div id="tags-list" class="space-y-2">
          <label class="text-xs text-gray-400">Tags</label>
          {% for tag in tx.tags %}
          <div class="flex gap-2 tag-row">
            <input type="text" name="tag_key_{{ loop.index0 }}" value="{{ tag.key }}"
                   class="w-1/3 bg-gray-800 border border-gray-700 rounded px-3 py-2 text-sm font-mono" placeholder="key">
            <input type="text" name="tag_value_{{ loop.index0 }}" value="{{ tag.value }}"
                   class="flex-1 bg-gray-800 border border-gray-700 rounded px-3 py-2 text-sm" placeholder="value">
            <button type="button" onclick="this.parentElement.remove()" class="text-red-400 hover:text-red-300 px-1">&times;</button>
          </div>
          {% endfor %}
        </div>
        <button type="button" onclick="addTag()" class="text-blue-400 hover:text-blue-300 text-xs">+ Add tag</button>

        {# ── Postings ── #}
        <div id="postings-list" class="space-y-2">
          <label class="text-xs text-gray-400">Postings</label>
          {% for p in tx.tpostings %}
          <div class="flex gap-2 posting-row">
            <input type="text" name="account_{{ loop.index0 }}" value="{{ p.paccount }}" list="acct-list"
                   class="flex-1 bg-gray-800 border border-gray-700 rounded px-3 py-2 text-sm" placeholder="Account">
            <input type="text" name="amount_{{ loop.index0 }}" value="{{ p.amount_display }}"
                   class="w-32 bg-gray-800 border border-gray-700 rounded px-3 py-2 text-sm font-mono" placeholder="Amount">
            {% if p.balance_assertion_display %}
            <input type="hidden" name="balance_assertion_{{ loop.index0 }}" value="{{ p.balance_assertion_display }}">
            {% endif %}
            <button type="button" onclick="this.parentElement.remove()" class="text-red-400 hover:text-red-300 px-1">&times;</button>
          </div>
          {% endfor %}
        </div>
        <datalist id="acct-list">
          {% for a in accounts %}
          <option value="{{ a }}">
          {% endfor %}
        </datalist>
        <button type="button" onclick="addPosting()" class="text-blue-400 hover:text-blue-300 text-sm">+ Add posting</button>

        <div class="flex gap-2 pt-3 border-t border-gray-800">
          <button type="submit" class="flex-1 bg-green-600 hover:bg-green-500 text-white text-sm py-2 rounded-lg">Save</button>
          <button type="button" onclick="document.getElementById('tx-edit').classList.add('hidden');document.getElementById('tx-view').classList.remove('hidden')"
                  class="flex-1 bg-gray-700 hover:bg-gray-600 text-white text-sm py-2 rounded-lg">Cancel</button>
        </div>
      </form>
    </div>

  </div>
</div>
<script>
function addTag(){
  const list=document.getElementById('tags-list');
  const n=list.querySelectorAll('.tag-row').length;
  const div=document.createElement('div');
  div.className='flex gap-2 tag-row';
  div.innerHTML=`<input type="text" name="tag_key_${n}" class="w-1/3 bg-gray-800 border border-gray-700 rounded px-3 py-2 text-sm font-mono" placeholder="key"><input type="text" name="tag_value_${n}" class="flex-1 bg-gray-800 border border-gray-700 rounded px-3 py-2 text-sm" placeholder="value"><button type="button" onclick="this.parentElement.remove()" class="text-red-400 hover:text-red-300 px-1">&times;</button>`;
  list.appendChild(div);
}
function addPosting(){
  const list=document.getElementById('postings-list');
  const n=list.querySelectorAll('.posting-row').length;
  const div=document.createElement('div');
  div.className='flex gap-2 posting-row';
  div.innerHTML=`<input type="text" name="account_${n}" list="acct-list" class="flex-1 bg-gray-800 border border-gray-700 rounded px-3 py-2 text-sm" placeholder="Account"><input type="text" name="amount_${n}" class="w-32 bg-gray-800 border border-gray-700 rounded px-3 py-2 text-sm font-mono" placeholder="Amount"><button type="button" onclick="this.parentElement.remove()" class="text-red-400 hover:text-red-300 px-1">&times;</button>`;
  list.appendChild(div);
}
</script>
