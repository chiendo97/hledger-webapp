<!-- Modal overlay -->
<div id="tx-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/70" onclick="if(event.target===this)document.getElementById('modal').innerHTML=''">
  <div class="bg-gray-900 border border-gray-700 rounded-xl w-full max-w-lg mx-4 max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">

    {# ── View mode ── #}
    <div id="tx-view">
      <div class="flex justify-between items-center p-4 border-b border-gray-800">
        <h2 class="text-lg font-semibold">Transaction #{{ tx.tindex }}</h2>
        <button onclick="document.getElementById('modal').innerHTML=''" class="text-gray-400 hover:text-white text-xl">&times;</button>
      </div>
      <div class="p-4 space-y-3">
        <div class="flex justify-between">
          <span class="text-gray-400 text-sm">Date</span>
          <span class="text-sm">{{ tx.tdate }}</span>
        </div>
        <div class="flex justify-between">
          <span class="text-gray-400 text-sm">Description</span>
          <span class="text-sm">{{ tx.tdescription }}</span>
        </div>
        {% if tx._tags %}
        <div class="space-y-1">
          {% for tag in tx._tags %}
          <div class="flex gap-2 text-sm">
            <span class="text-gray-500 font-mono">{{ tag.key }}</span>
            <span class="text-gray-300">{{ tag.value }}</span>
          </div>
          {% endfor %}
        </div>
        {% endif %}
        <div class="border-t border-gray-800 pt-3 space-y-2">
          {% for p in tx.tpostings %}
          <div class="flex justify-between text-sm">
            <span class="text-gray-300 truncate mr-2">{{ p.paccount }}</span>
            <span class="font-mono whitespace-nowrap {% if p.pamount[0].aquantity.floatingPoint < 0 %}text-red-400{% else %}text-green-400{% endif %}">{{ p._amount }}</span>
          </div>
          {% if p._tags %}
          <div class="ml-4 space-y-0.5">
            {% for tag in p._tags %}
            <div class="flex gap-2 text-xs text-gray-500">
              <span class="font-mono">{{ tag.key }}</span>
              <span>{{ tag.value }}</span>
            </div>
            {% endfor %}
          </div>
          {% endif %}
          {% endfor %}
        </div>
        <div class="flex gap-2 pt-3 border-t border-gray-800">
          <button onclick="document.getElementById('tx-view').classList.add('hidden');document.getElementById('tx-edit').classList.remove('hidden')"
                  class="flex-1 bg-blue-600 hover:bg-blue-500 text-white text-sm py-2 rounded-lg">Edit</button>
          <button onclick="document.getElementById('modal').innerHTML=''"
                  class="flex-1 bg-gray-700 hover:bg-gray-600 text-white text-sm py-2 rounded-lg">Close</button>
        </div>
      </div>
    </div>

    {# ── Edit mode ── #}
    <div id="tx-edit" class="hidden">
      <div class="flex justify-between items-center p-4 border-b border-gray-800">
        <h2 class="text-lg font-semibold">Edit Transaction</h2>
        <button onclick="document.getElementById('modal').innerHTML=''" class="text-gray-400 hover:text-white text-xl">&times;</button>
      </div>
      <form hx-post="/transactions/{{ tx.tindex }}" hx-target="#modal" hx-swap="innerHTML" class="p-4 space-y-3">
        <div>
          <label class="text-xs text-gray-400">Date</label>
          <input type="date" name="date" value="{{ tx.tdate }}"
                 class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-sm mt-1">
        </div>
        <div>
          <label class="text-xs text-gray-400">Description</label>
          <input type="text" name="description" value="{{ tx.tdescription }}"
                 class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-sm mt-1">
        </div>

        {# ── Tags (key:value) ── #}
        <div id="tags-list" class="space-y-2">
          <label class="text-xs text-gray-400">Tags</label>
          {% for tag in tx._tags %}
          <div class="flex gap-2 tag-row">
            <input type="text" name="tag_key_{{ loop.index0 }}" value="{{ tag.key }}"
                   class="w-1/3 bg-gray-800 border border-gray-700 rounded px-3 py-2 text-sm font-mono" placeholder="key">
            <input type="text" name="tag_value_{{ loop.index0 }}" value="{{ tag.value }}"
                   class="flex-1 bg-gray-800 border border-gray-700 rounded px-3 py-2 text-sm" placeholder="value">
            <button type="button" onclick="this.parentElement.remove()" class="text-red-400 hover:text-red-300 px-1">&times;</button>
          </div>
          {% endfor %}
        </div>
        <button type="button" onclick="addTag()" class="text-blue-400 hover:text-blue-300 text-xs">+ Add tag</button>

        {# ── Postings ── #}
        <div id="postings-list" class="space-y-2">
          <label class="text-xs text-gray-400">Postings</label>
          {% for p in tx.tpostings %}
          <div class="flex gap-2 posting-row">
            <input type="text" name="account_{{ loop.index0 }}" value="{{ p.paccount }}" list="acct-list"
                   class="flex-1 bg-gray-800 border border-gray-700 rounded px-3 py-2 text-sm" placeholder="Account">
            <input type="text" name="amount_{{ loop.index0 }}" value="{{ p._amount }}"
                   class="w-32 bg-gray-800 border border-gray-700 rounded px-3 py-2 text-sm font-mono" placeholder="Amount">
            <button type="button" onclick="this.parentElement.remove()" class="text-red-400 hover:text-red-300 px-1">&times;</button>
          </div>
          {% endfor %}
        </div>
        <datalist id="acct-list">
          {% for a in accounts %}
          <option value="{{ a }}">
          {% endfor %}
        </datalist>
        <button type="button" onclick="addPosting()" class="text-blue-400 hover:text-blue-300 text-sm">+ Add posting</button>

        <div class="flex gap-2 pt-3 border-t border-gray-800">
          <button type="submit" class="flex-1 bg-green-600 hover:bg-green-500 text-white text-sm py-2 rounded-lg">Save</button>
          <button type="button" onclick="document.getElementById('tx-edit').classList.add('hidden');document.getElementById('tx-view').classList.remove('hidden')"
                  class="flex-1 bg-gray-700 hover:bg-gray-600 text-white text-sm py-2 rounded-lg">Cancel</button>
        </div>
      </form>
    </div>

  </div>
</div>
<script>
function addTag(){
  const list=document.getElementById('tags-list');
  const n=list.querySelectorAll('.tag-row').length;
  const div=document.createElement('div');
  div.className='flex gap-2 tag-row';
  div.innerHTML=`<input type="text" name="tag_key_${n}" class="w-1/3 bg-gray-800 border border-gray-700 rounded px-3 py-2 text-sm font-mono" placeholder="key"><input type="text" name="tag_value_${n}" class="flex-1 bg-gray-800 border border-gray-700 rounded px-3 py-2 text-sm" placeholder="value"><button type="button" onclick="this.parentElement.remove()" class="text-red-400 hover:text-red-300 px-1">&times;</button>`;
  list.appendChild(div);
}
function addPosting(){
  const list=document.getElementById('postings-list');
  const n=list.querySelectorAll('.posting-row').length;
  const div=document.createElement('div');
  div.className='flex gap-2 posting-row';
  div.innerHTML=`<input type="text" name="account_${n}" list="acct-list" class="flex-1 bg-gray-800 border border-gray-700 rounded px-3 py-2 text-sm" placeholder="Account"><input type="text" name="amount_${n}" class="w-32 bg-gray-800 border border-gray-700 rounded px-3 py-2 text-sm font-mono" placeholder="Amount"><button type="button" onclick="this.parentElement.remove()" class="text-red-400 hover:text-red-300 px-1">&times;</button>`;
  list.appendChild(div);
}
</script>
